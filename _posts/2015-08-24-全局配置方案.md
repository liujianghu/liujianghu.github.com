---
layout:     post
title:      ".NET全部配置方案"
subtitle:   "解决各个项目配置乱而杂的问题."
date:       2015-08-24 22:00:00
author:     "极品拖拉机"
header-img: "img/post-bg-01.jpg"
---

在.net项目中，经常会需要根据配置来进行处理，而每个项目，都可能不少配置。每次需要修改配置的时候，都需要跑到服务器下去修改web.config。麻烦，而且容易出错。
  
之前的公司采用了一个解决方案，我拿过来，修改了一下，算是初步的解决了一些问题吧。
  
### 整体思路如下:
1. 所有的配置，都保存在一个地方，我这边使用的是mysql，其实mongodb也可以考虑。然后每个环境都部署一个这样的库，比如本地开发一个，测试一个，生产环境一个。
2. 配置可在可视化界面进行管理。修改配置之后，可以通过自己写的程序去把相应站点的应用程序池回收生效。
3. 修改每台机器的`C:\Windows\Microsoft.NET\Framework\v4.0.30319\Config\machine.config` connectionstrings节点， 增加一个通用配置库的连接字符串，这样每台机器上所有的程序都可以获取这个连接字符串，从而去读取配置库。
  
### 通用配置库比结构如下：
1. 环境(Env)：对应所有的环境，还有实现父子关系。每个环境可以继承另外一个环境，如果子环境和父环境有相同的配置，则去子环境的。
> Id
> Name: 环境名称
> ParentId: 父级环境ID
> Remark: 说明
2. 服务器(Server)：对应所有的服务器
> Id
> Name: 服务器的电脑名称(一定是实际的电脑名称)
> EnvId：所属环境
> IntranetIP: 内网IP
> Ip：外网IP
> Remark: 说明
3. 键值(ConfigValue)： 对应AppSetting
> Id
> Key: 建议这个key加上命名空间以区分每个项目
> Value
> EnvId: 所属环境
> IsActived: 是否启用，默认为true
> Remark
4. 数据库连接字符串(ConnectionString)： 对应ConnectionString
字段和ConfigValue一样。

### 程序设计
1. 可以写一个通用类库，程序启动的时候，从Environment类获取当前的机器名，然后根据名称去Server表里面获取对应的环境。然后读取所有此环境及其父环境的ConfigValues和Connections， 放入一个全局的Dictionary中。如果遇见重复的Key,则优先取此服务器环境的数据
